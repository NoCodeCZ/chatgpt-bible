# Global QA Gate Rules for CharGPT Bible Project
# Version: 1.0
# Last Updated: 2025-11-10
# Purpose: Define standards and processes for all QA gates in the project

metadata:
  version: "1.0"
  last_updated: "2025-11-10"
  owner: "Test Architect (Quinn)"
  applies_to: "All Epic 1-4 stories"

# ==============================================================================
# QA GATE LOCATION & NAMING CONVENTIONS
# ==============================================================================

location:
  primary_directory: "app-planning/qa/gates/"
  remediation_directory: "app-planning/qa/remediation/"
  description: "All QA gate decisions must be stored in the primary directory"

naming_conventions:
  format: "epic-{epic_number}.story-{story_number}-{story-slug}.yml"
  examples:
    - "epic-1.story-1.1-initialize-nextjs.yml"
    - "epic-1.story-1.5-build-prompt-list-page.yml"
    - "epic-2.story-2.1-migrate-prompt-library.yml"
  alternative_format: "{story_number}-{story-slug}.yml"
  alternative_examples:
    - "1.3-connect-nextjs-to-directus.yml"
    - "1.4-create-public-landing-page.yml"

  remediation_format: "epic-{epic_number}.story-{story_number}-qa-fixes-applied.md"
  remediation_examples:
    - "epic-1.story-1.5-qa-fixes-applied.md"

# ==============================================================================
# QA GATE DECISION CRITERIA
# ==============================================================================

decision_criteria:
  pass_threshold: 95  # Percentage of acceptance criteria that must be met
  pass_with_concerns_threshold: 85  # Can pass with documented non-blocking issues
  fail_threshold: 84  # Below this, automatic FAIL

  confidence_levels:
    high: ">= 90%"
    medium: "70-89%"
    low: "< 70%"

  blocker_policy:
    critical_blockers: "Any critical blocker = automatic FAIL"
    high_risk_limit: 2  # Max 2 high-risk issues for PASS WITH CONCERNS
    medium_risk_limit: 5  # Max 5 medium-risk issues for PASS WITH CONCERNS

# ==============================================================================
# REQUIRED QA GATE STRUCTURE
# ==============================================================================

required_sections:
  metadata:
    fields:
      - gate_id: "Unique identifier for this QA gate"
      - story_reference: "Link to story definition"
      - reviewer: "Name/role of reviewer (e.g., Quinn - Test Architect)"
      - review_date: "ISO 8601 date (YYYY-MM-DD)"
      - review_iteration: "Integer (1, 2, 3...)"
      - confidence_level: "HIGH | MEDIUM | LOW"

  decision:
    required_fields:
      - status: "PASS | PASS WITH MINOR CONCERNS | FAIL"
      - production_ready: "YES | NO | CONDITIONAL"
      - go_live_approval: "APPROVED | CONDITIONAL | BLOCKED"
    optional_fields:
      - overall_quality_score: "0-100 numeric score"
      - estimated_remediation_time: "Human-readable estimate (e.g., '6-8 hours')"

  findings:
    categories:
      critical_blockers:
        severity: "CRITICAL"
        definition: "Functional gaps, security vulnerabilities, data loss risks"
        action: "Must fix before production"

      high_risk_items:
        severity: "HIGH"
        definition: "Significant deviations from requirements, poor UX, performance issues"
        action: "Should fix before production"

      medium_risk_items:
        severity: "MEDIUM"
        definition: "Minor functional gaps, accessibility issues, missing error states"
        action: "Fix in next iteration"

      low_risk_items:
        severity: "LOW"
        definition: "Code quality improvements, optimization opportunities"
        action: "Optional, can defer"

  acceptance_criteria_analysis:
    required_fields:
      - criteria_id: "Reference to story AC number"
      - status: "MET | PARTIAL | NOT_MET | NOT_APPLICABLE"
      - evidence: "Description of implementation or gap"
      - risk_level: "CRITICAL | HIGH | MEDIUM | LOW | NONE"

  recommendations:
    types:
      - immediate_actions: "Must do before re-review"
      - follow_up_actions: "Can defer to future iterations"
      - architectural_improvements: "Long-term enhancements"

# ==============================================================================
# ACCEPTANCE CRITERIA VALIDATION RULES
# ==============================================================================

acceptance_criteria_rules:
  validation_approach:
    - "Each AC from story definition must be individually assessed"
    - "Status must be one of: MET, PARTIAL, NOT_MET, NOT_APPLICABLE"
    - "Evidence must include specific file paths and line numbers when applicable"

  met_criteria:
    definition: "100% implemented as specified in story"
    evidence_required: "Code references, test results, or screenshots"

  partial_criteria:
    definition: "Partially implemented, missing minor elements"
    evidence_required: "What's implemented + what's missing"
    counts_as: "50% credit toward pass threshold"

  not_met_criteria:
    definition: "Not implemented or fundamentally incorrect"
    evidence_required: "Description of gap"
    counts_as: "0% credit"

  not_applicable_criteria:
    definition: "AC no longer relevant due to architecture changes"
    evidence_required: "Explanation of why not applicable"
    counts_as: "Excluded from percentage calculation"

# ==============================================================================
# REMEDIATION PROCESS
# ==============================================================================

remediation:
  process:
    1_create_remediation_doc:
      action: "Create markdown file in app-planning/qa/remediation/"
      required_content:
        - "List of all issues from QA gate"
        - "Detailed fix description for each issue"
        - "Code changes with file paths and diffs"
        - "Test results confirming fixes"

    2_implement_fixes:
      action: "Address all CRITICAL and HIGH severity issues"
      verification: "Run full TypeScript build, test suite, manual testing"

    3_request_rereviw:
      action: "Update QA gate YAML with re-review request"
      trigger: "Reviewer runs QA gate again"

    4_track_deferred_items:
      action: "Add MEDIUM/LOW issues to project backlog"
      location: "GitHub Issues or project management tool"

  remediation_doc_template:
    filename: "epic-{epic}.story-{story}-qa-fixes-applied.md"
    sections:
      - summary: "Overview of QA gate result and actions taken"
      - critical_fixes: "All CRITICAL blocker resolutions"
      - high_risk_fixes: "All HIGH risk item resolutions"
      - test_results: "Build status, test output, screenshots"
      - remaining_items: "Deferred MEDIUM/LOW items with justification"
      - ready_for_rereviw: "Confirmation that all blockers resolved"

# ==============================================================================
# REVIEW ITERATION POLICY
# ==============================================================================

review_iterations:
  iteration_1:
    description: "Initial QA gate review"
    expected_outcome: "PASS, PASS WITH CONCERNS, or FAIL with detailed findings"

  iteration_2:
    description: "Re-review after remediation"
    prerequisites:
      - "Remediation document created"
      - "All CRITICAL blockers fixed"
      - "Build passing"
    expected_outcome: "PASS or PASS WITH CONCERNS (or FAIL if issues remain)"

  iteration_3_plus:
    description: "Exceptional cases only"
    escalation: "If 3+ iterations needed, escalate to project lead"
    root_cause_analysis: "Required to prevent recurring issues"

# ==============================================================================
# PRODUCTION READINESS CHECKLIST
# ==============================================================================

production_readiness:
  required_for_approval:
    functional:
      - "All CRITICAL acceptance criteria met"
      - "No CRITICAL blockers"
      - "Core user flows work end-to-end"

    technical:
      - "TypeScript build passes with strict mode"
      - "No console errors on production build"
      - "All environment variables documented"

    security:
      - "No hardcoded secrets or API keys"
      - "Authentication/authorization working"
      - "Input validation in place"

    performance:
      - "Page load < 3 seconds (4G connection)"
      - "No obvious performance bottlenecks"
      - "Lighthouse score >= 80 (MVP target)"

    accessibility:
      - "Keyboard navigation functional"
      - "Color contrast meets WCAG 2.1 AA"
      - "Screen reader friendly (basic)"

    documentation:
      - "README updated with setup instructions"
      - "Environment variables documented"
      - "Known issues logged (if any)"

# ==============================================================================
# SPECIAL RULES FOR MVP (EPIC 1-4)
# ==============================================================================

mvp_exceptions:
  allowed_deferrals:
    - "Advanced error handling (e.g., retry logic)"
    - "Comprehensive unit test coverage (defer to post-MVP)"
    - "Lighthouse score < 90 (80+ acceptable for MVP)"
    - "Advanced accessibility features (beyond WCAG AA basics)"
    - "Performance optimizations beyond critical path"

  not_allowed_deferrals:
    - "Core functional requirements"
    - "Security vulnerabilities"
    - "Data integrity issues"
    - "TypeScript strict mode violations"
    - "Broken user flows"

  rationale: "2-week timeline requires pragmatic quality tradeoffs, but not at expense of core functionality or security"

# ==============================================================================
# AUTOMATED CHECKS (MUST PASS BEFORE QA GATE)
# ==============================================================================

automated_checks:
  pre_qa_requirements:
    build:
      command: "npm run build"
      requirement: "Must pass without errors"

    type_check:
      command: "npm run type-check"
      requirement: "Must pass with TypeScript strict mode"

    lint:
      command: "npm run lint"
      requirement: "No errors (warnings acceptable)"

  optional_checks:
    unit_tests:
      command: "npm run test"
      requirement: "Not required for MVP, but encouraged"

    lighthouse:
      tool: "Chrome DevTools Lighthouse"
      requirement: "Score >= 80 for performance, accessibility, best practices"

# ==============================================================================
# QA GATE REVIEWER RESPONSIBILITIES
# ==============================================================================

reviewer_responsibilities:
  required_actions:
    - "Review all code changes since last commit"
    - "Test all acceptance criteria manually"
    - "Verify TypeScript build passes"
    - "Check for security vulnerabilities"
    - "Validate against CLAUDE.md requirements"
    - "Document all findings with severity levels"
    - "Provide actionable remediation guidance"

  prohibited_actions:
    - "Approving without testing all ACs"
    - "Skipping security review"
    - "Passing with undocumented CRITICAL blockers"
    - "Making assumptions without verification"

  time_commitment:
    - "Initial review: 2-4 hours per story"
    - "Re-review: 30-60 minutes per story"
    - "Complex stories (e.g., 1.5, 1.8): 4-6 hours"

# ==============================================================================
# ESCALATION PROCESS
# ==============================================================================

escalation:
  trigger_conditions:
    - "3+ review iterations without resolution"
    - "Unresolvable architectural conflicts"
    - "Security vulnerability beyond developer expertise"
    - "Timeline impact > 1 day from remediation"

  escalation_path:
    1: "Project Lead (Technical)"
    2: "Architecture Review (if applicable)"
    3: "Business Stakeholder (if scope change needed)"

  documentation_required:
    - "Summary of issue"
    - "Attempted solutions"
    - "Impact assessment"
    - "Recommended path forward"

# ==============================================================================
# CONTINUOUS IMPROVEMENT
# ==============================================================================

continuous_improvement:
  retrospective_triggers:
    - "After each epic completion"
    - "After 3+ FAIL decisions in sequence"
    - "After any CRITICAL security finding"

  metrics_to_track:
    - "Pass rate (target: >= 80% first-time)"
    - "Average review iterations (target: <= 1.5)"
    - "Remediation time (target: <= 6 hours)"
    - "Critical blockers per story (target: <= 1)"

  improvement_actions:
    - "Update this rules document"
    - "Create new story templates"
    - "Add automated checks"
    - "Enhance developer training"

# ==============================================================================
# REFERENCES
# ==============================================================================

references:
  project_documentation:
    - "CLAUDE.md - Project instructions and tech stack"
    - "app-planning/stories/*.md - Individual story definitions"
    - "docs/prd.md - Product requirements document"
    - "docs/architecture.md - Technical architecture"

  quality_standards:
    - "TypeScript strict mode (tsconfig.json)"
    - "WCAG 2.1 Level AA (accessibility)"
    - "OWASP Top 10 (security)"
    - "Next.js best practices (performance)"
